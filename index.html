<!DOCTYPE html>
<html style="width:100%;height:100%;">
  <body style="width:100%;height:100%;margin:0;">
    <button class="btn" id="-1d">-1d</button>
    <button class="btn" id="-3d">-3d</button>
    <button class="btn" id="-1w">-1w</button>
    <button class="btn" id="-1m">-1m</button>
    <button class="btn" id="-1y">-1y</button>
    <button class="btn" id="all">all</button>
    <script src="./config.js"></script>
    <script src="./funcs.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.26.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.0/simple_statistics.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.1.6.min.js"></script>

    <script>
      function changeVizAttributes() {
        d3.selectAll(".dimple-custom-series-bar").attr("opacity", "0.3");
        d3.selectAll(".dimple-custom-series-bubble").attr("opacity", "0.9").attr("r", 2);
      }

      function drawChart(data, xDataFieldName, yDataFieldName) {
        var svg = dimple.newSvg("body", "100%", "95%");
        var chart = new dimple.chart(svg, data);
        chart.setMargins("100px", "10px", "10px", "180px");
        var x = chart.addTimeAxis("x", xDataFieldName, null, "%a, %Y-%m-%d %H:%M:%S");
        x.timePeriod = d3.time.hours;
        x.timeInterval = 3;
        var y = chart.addMeasureAxis("y", yDataFieldName);
        var yMean = chart.addMeasureAxis(y, "mean");
        var yQ50 = chart.addMeasureAxis(y, "q50");
        var yQ80 = chart.addMeasureAxis(y, "q80");
        chart.addColorAxis(yDataFieldName, ["red", "green"]);
        chart.addSeries(yDataFieldName, dimple.plot.bar);
        chart.addSeries(yDataFieldName, dimple.plot.blubble);
        chart.addSeries("mean", dimple.plot.line, [x, yMean]);
        chart.addSeries("q50", dimple.plot.line, [x, yQ50]);
        chart.addSeries("q80", dimple.plot.line, [x, yQ80]);
        chart.draw();
        changeVizAttributes();
        window.onresize = function () {
          chart.draw(0, noDataChange=true);
          changeVizAttributes();
        };
      };

      var oneDayInSeconds = 24 * 60 * 60;

      funcs.fetchDataFromDynamoDB(oneDayInSeconds, drawChart);

      d3.selectAll(".btn").on("click", function() {
        var backInTimeSeconds = funcs.calculateBackinTimeSeconds(d3.event.target.id);
        d3.select("svg").remove();
        funcs.fetchDataFromDynamoDB(backInTimeSeconds, drawChart);
      });
    </script>
  </body>
</html>
