<!DOCTYPE html>
<html style="width:100%;height:100%;">
  <body style="width:100%;height:100%;margin:0;">
    <button class="btn" id="-1d">-1d</button>
    <button class="btn" id="-3d">-3d</button>
    <button class="btn" id="-1w">-1w</button>
    <button class="btn" id="-1m">-1m</button>
    <button class="btn" id="-1y">-1y</button>
    <button class="btn" id="all">all</button>
    <script src="./config.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.26.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.0/simple_statistics.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.1.6.min.js"></script>

    <script>
      function fetchDataFromDynamoDB(newerThan) {
        AWS.config.update({
          accessKeyId: config.awsAccessKeyId,
          secretAccessKey: config.awsSecretAccessKey
        });
        AWS.config.region = config.awsRegion;
        var dynamoDb = new AWS.DynamoDB();

        var scanParams = {};
        scanParams.TableName = config.tableName;
        scanParams.FilterExpression = "#timeField >= :oldest";
        scanParams.ExpressionAttributeNames = {
          "#timeField": config.timeDataFieldName
        };
        scanParams.ExpressionAttributeValues = {
          ":oldest": { "N": newerThan.toString() }
        };

        var data = [];
        dynamoDb.scan(params = scanParams, function(err, fetchedData) {
          if (err) {
            console.log("Error on scan: ", JSON.stringify(err, null, 2));
          } else {
            fetchedData = fetchedData.Items;
            fetchedData.forEach(function(item){
              var dataItem = {};
              // in JavaScript epoch time is in milliseconds, not seconds:
              dataItem[config.timeDataFieldName] = Number(item.timestamp.N * 1000);
              dataItem[config.valueDataFieldName] = Number(item.download_bit_per_second.N);
              data.push(dataItem);
            });
            var values = data.map(function(item) { return item[config.valueDataFieldName]; }).
              sort(function(a, b) {return a -b});
            var min = ss.min(values);
            var max = ss.max(values);
            var mean = ss.mean(values);
            var q90 = ss.quantileSorted(values, 0.1);
            var q75 = ss.quantileSorted(values, 0.25);
            var q50 = ss.quantileSorted(values, 0.5);
            data = data.map(function(item) {
              item["min"] = min;
              item["max"] = max;
              item["mean"] = mean;
              item["q90"] = q90;
              item["q75"] = q75;
              item["q50"] = q50;
              return item;
            });
            drawChart(data, config.timeDataFieldName, config.valueDataFieldName);
          }
        })
      }

      function changeVizAttributes() {
        d3.selectAll(".dimple-custom-series-bar").attr("opacity", "0.3");
        d3.selectAll(".dimple-custom-series-bubble").attr("opacity", "0.9").attr("r", 2);
      }

      function drawChart(data, xDataFieldName, yDataFieldName) {
        var svg = dimple.newSvg("body", "100%", "95%");
        var chart = new dimple.chart(svg, data);
        chart.setMargins("100px", "10px", "10px", "180px");
        var x = chart.addTimeAxis("x", xDataFieldName, null, "%Y-%m-%d %H:%M:%S");
        x.timePeriod = d3.time.hours;
        x.timeInterval = 3;
        var y = chart.addMeasureAxis("y", yDataFieldName);
        var yMin = chart.addMeasureAxis(y, "min");
        var yMax = chart.addMeasureAxis(y, "max");
        var yMean = chart.addMeasureAxis(y, "mean");
        var yQ90 = chart.addMeasureAxis(y, "q90");
        var yQ75 = chart.addMeasureAxis(y, "q75");
        var yQ50 = chart.addMeasureAxis(y, "q50");
        chart.addColorAxis(yDataFieldName, ["red", "green"]);
        chart.addSeries(yDataFieldName, dimple.plot.bar);
        chart.addSeries(yDataFieldName, dimple.plot.blubble);
        chart.addSeries("min", dimple.plot.line, [x, yMin]);
        chart.addSeries("max", dimple.plot.line, [x, yMax]);
        chart.addSeries("mean", dimple.plot.line, [x, yMean]);
        chart.addSeries("q90", dimple.plot.line, [x, yQ90]);
        chart.addSeries("q75", dimple.plot.line, [x, yQ75]);
        chart.addSeries("q50", dimple.plot.line, [x, yQ50]);
        chart.draw();
        changeVizAttributes();
        window.onresize = function () {
          chart.draw(0, noDataChange=true);
          changeVizAttributes();
        };
      };

      var nowInSeconds = new Date().getTime() / 1000;
      var oneDayInSeconds = 24 * 60 * 60;
      var threeDaysInSeconds = 3 * oneDayInSeconds;
      var oneWeekInSeconds = 7 * oneDayInSeconds;
      var oneMonthInSeconds = 30 * oneDayInSeconds;
      var oneYearInSeconds = 365 * oneDayInSeconds;

      fetchDataFromDynamoDB(nowInSeconds - oneDayInSeconds);

      d3.selectAll(".btn").on("click", function() {
        var oldestTimestamp = 0;
        switch(d3.event.target.id) {
          case "-1d":
            oldestTimestamp = nowInSeconds - oneDayInSeconds;
            break;
          case "-3d":
            oldestTimestamp = nowInSeconds -threeDaysInSeconds;
            break;
          case "-1w":
            oldestTimestamp = nowInSeconds - oneWeekInSeconds;
            break;
          case "-1m":
            oldestTimestamp = nowInSeconds - oneMonthInSeconds;
            break;
          case "-1y":
            oldestTimestamp = nowInSeconds - oneYearInSeconds;
            break;
        };

        d3.select("svg").remove();
        fetchDataFromDynamoDB(oldestTimestamp);
      });
    </script>
  </body>
</html>
